name: è‡ªåŠ¨éƒ¨ç½²åˆ°CF Worker

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
      - '.github/**'
  workflow_dispatch:

jobs:
  auto-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
    
      - name: ğŸ”„ æ›¿æ¢wrangler.tomlä¸­çš„å˜é‡
        id: config_setup
        env:
          CF_KV_ID: ${{ secrets.CF_KV_ID }}
          CF_CRONS: ${{ secrets.CF_CRONS || '0 1,13 * * *' }}
        run: |
          sed -i "s#{CF_KV_ID}#${CF_KV_ID}#g" wrangler.toml
          sed -i "s#{CF_CRONS}#${CF_CRONS}#g" wrangler.toml
          
          WORKER_NAME=$(grep '^name =' wrangler.toml | awk -F '"' '{print $2}')
          if [ -z "$WORKER_NAME" ]; then
            echo "é”™è¯¯: æœªèƒ½åœ¨ wrangler.toml ä¸­æ‰¾åˆ° 'name' å­—æ®µ"; exit 1
          fi
          echo "é¡¹ç›®åç§°: $WORKER_NAME"
          echo "worker_name=$WORKER_NAME" >> $GITHUB_OUTPUT
          echo "WORKER é…ç½®ä¿¡æ¯å¦‚ä¸‹:"
          cat wrangler.toml
          
      - name: ğŸš€ éƒ¨ç½²åˆ°CF Worker
        uses: cloudflare/wrangler-action@v4
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ vars.CF_ACCOUNT_ID }}
          
      - name: âœ¨ è¾“å‡ºé¡¹ç›®åœ°å€
        env:
          WORKER_NAME: ${{ steps.config_setup.outputs.worker_name }}
          ACCOUNT_ID: ${{ vars.CF_ACCOUNT_ID }}
        run: |
          echo "âœ¨ ---éƒ¨ç½²å®Œæˆ---"
          echo "ğŸŒ Workerç®¡ç†åå°:"
          echo "https://dash.cloudflare.com/${ACCOUNT_ID}/workers/services/view/${WORKER_NAME}/production/settings"
